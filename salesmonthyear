delete from PAL_KMEANS_ASSIGNED_TBL;
delete from "ML_DATA".PAL_KMEANS_CENTERS_sales_TBL;
delete from "ML_DATA"."salesdataml";



 
INSERT INTO "ML_DATA"."salesdataml" (ID,SALES,MONTH_ID,YEAR_ID) 
select ORDERNUMBER,SALES,MONTH_ID,YEAR_ID from "ML_DATA"."sales_data_sample"; 




DROP TYPE PAL_KMEANS_CENTERS_sales;
CREATE TYPE  PAL_KMEANS_CENTERS_sales AS TABLE(
          "CLUSTER_ID" INTEGER,
 	  "SALES" DOUBLE, 
	  "MONTH_ID" INTEGER CS_INT, 
          "YEAR_ID" INTEGER CS_INT
);

DROP TABLE PAL_KMEANS_CENTERS_sales_TBL;
CREATE COLUMN TABLE PAL_KMEANS_CENTERS_sales_TBL LIKE  PAL_KMEANS_CENTERS_sales;

DROP TYPE PAL_KMEANS_ASSIGNED_T;
CREATE TYPE PAL_KMEANS_ASSIGNED_T AS TABLE(
"ID" INTEGER,
"CLUSTER" INTEGER,
"DISTANCE" DOUBLE,
"SLIGHT_SILHOUETTE" DOUBLE
);
DROP TABLE PAL_KMEANS_ASSIGNED_TBL;
CREATE COLUMN TABLE PAL_KMEANS_ASSIGNED_TBL LIKE PAL_KMEANS_ASSIGNED_T;

DROP TABLE #PAL_PARAMETER_TBL;
CREATE LOCAL TEMPORARY COLUMN TABLE #PAL_PARAMETER_TBL(
	"PARAM_NAME" NVARCHAR(256), 
	"INT_VALUE" INTEGER, 
	"DOUBLE_VALUE" DOUBLE, 
	"STRING_VALUE" NVARCHAR(1000)
);

INSERT INTO #PAL_PARAMETER_TBL VALUES ('THREAD_RATIO', NULL, 0.2, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('GROUP_NUMBER', 3, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('INIT_TYPE', 1, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('DISTANCE_LEVEL',2, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('MAX_ITERATION', 100, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('EXIT_THRESHOLD', NULL, 1.0E-6, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('CATEGORY_WEIGHTS', NULL, 0.5, NULL);

CALL _SYS_AFL.PAL_KMEANS("ML_DATA"."salesdataml", "ML_DATA".#PAL_PARAMETER_TBL, "ML_DATA".PAL_KMEANS_ASSIGNED_TBL,"ML_DATA".PAL_KMEANS_CENTERS_sales_TBL, ?, ?, ?) WITH OVERVIEW; 

select avg(SLIGHT_SILHOUETTE) from "ML_DATA".PAL_KMEANS_ASSIGNED_TBL;

select s.PRODUCTCODE,s.PRODUCTLINE,s.CUSTOMERNAME,s.STATE,s.COUNTRY,
s.MONTH_ID,s.YEAR_ID,s.QUANTITYORDERED,k.CLUSTER from "ML_DATA"."sales_data_sample" s, "ML_DATA".PAL_KMEANS_ASSIGNED_TBL k
where s.ORDERNUMBER = k.ID 
and k.CLUSTER = 0 ;
