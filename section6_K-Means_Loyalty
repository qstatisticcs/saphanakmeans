-----------------------------------------------------------------------
---LOYALTY EXAMPLE
-----------------------------------------------------------------------

delete from PAL_KMEANS_ASSIGNED_TBL;
delete from "ML_DATA"."PAL_KMEANS_CENTERS_customerthreevariables_TBL";
 
DROP TABLE "ML_DATA"."customerthreevariables";
CREATE COLUMN TABLE "ML_DATA"."customerthreevariables" 
("ID" INTEGER , 
"LIFESPEND" DOUBLE , 
"INCOME" DOUBLE,
"LOYALTY" DOUBLE
);

INSERT INTO "ML_DATA"."customerthreevariables" (ID,LIFESPEND,INCOME,LOYALTY) 
select ID,LIFESPEND,INCOME,LOYALTY from "ML_DATA"."CUSTOMERS1M"; 


DROP TYPE PAL_KMEANS_CENTERS_customerthreevariables;
CREATE TYPE  PAL_KMEANS_CENTERS_customerthreevariables AS TABLE(
          "CLUSTER_ID" INTEGER,
 	  "LIFESPEND" DOUBLE, 
 	  "INCOME" DOUBLE,
	  "LOYALTY" DOUBLE
);

DROP TABLE PAL_KMEANS_CENTERS_customerthreevariables_TBL;
CREATE COLUMN TABLE PAL_KMEANS_CENTERS_customerthreevariables_TBL LIKE  PAL_KMEANS_CENTERS_customerthreevariables;

DROP TABLE #PAL_PARAMETER_TBL;
CREATE LOCAL TEMPORARY COLUMN TABLE #PAL_PARAMETER_TBL("PARAM_NAME" NVARCHAR(256),"INT_VALUE" INTEGER, "DOUBLE_VALUE" DOUBLE, "STRING_VALUE" NVARCHAR(1000));
INSERT INTO #PAL_PARAMETER_TBL VALUES ('THREAD_RATIO', NULL, 0.2, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES('GROUP_NUMBER', 2, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('INIT_TYPE', 1, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('DISTANCE_LEVEL',2, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('MAX_ITERATION', 100, NULL, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('EXIT_THRESHOLD', NULL, 1.0E-6, NULL);
INSERT INTO #PAL_PARAMETER_TBL VALUES ('CATEGORY_WEIGHTS', NULL, 0.5, NULL);

CALL _SYS_AFL.PAL_KMEANS("ML_DATA"."customerthreevariables", #PAL_PARAMETER_TBL, "ML_DATA"."PAL_KMEANS_ASSIGNED_TBL","ML_DATA"."PAL_KMEANS_CENTERS_customerthreevariables_TBL", ?, ?, ?) WITH OVERVIEW;

select avg(SLIGHT_SILHOUETTE) from "ML_DATA".PAL_KMEANS_ASSIGNED_TBL;
